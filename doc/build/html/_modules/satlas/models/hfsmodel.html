<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8">
    
    <title>satlas.models.hfsmodel &mdash; SATLAS 0.1.0b26 documentation</title>
    
    <link rel="stylesheet" type="text/css" href="../../../_static/css/spc-bootstrap.css">
    <link rel="stylesheet" type="text/css" href="../../../_static/css/spc-extend.css">
    <link rel="stylesheet" href="../../../_static/scipy.css" type="text/css" >
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" >
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '0.1.0b26',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/js/copybutton.js"></script>
    <link rel="top" title="SATLAS 0.1.0b26 documentation" href="../../../index.html" >
    <link rel="up" title="Module code" href="../../index.html" > 
  </head>
  <body>

  <div class="container">
    <div class="header">
    </div>
  </div>


    <div class="container">
      <div class="main">
        
	<div class="row-fluid">
	  <div class="span12">
	    <div class="spc-navbar">
              
    <ul class="nav nav-pills pull-left">
	
        <li class="active"><a href="../../../index.html">SATLAS 0.1.0b26 documentation</a></li>
	
          <li class="active"><a href="../../index.html" accesskey="U">Module code</a></li> 
    </ul>
              
              
    <ul class="nav nav-pills pull-right">
      <li class="active">
        <a href="../../../genindex.html" title="General Index"
           accesskey="I">index</a>
      </li>
      <li class="active">
        <a href="../../../py-modindex.html" title="Python Module Index"
           >modules</a>
      </li>
    </ul>
              
	    </div>
	  </div>
	</div>
        

	<div class="row-fluid">
          <div class="span9">
            
        <div class="bodywrapper">
          <div class="body" id="spc-section-body">
            
  <h1>Source code for satlas.models.hfsmodel</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Implementation of a class for the analysis of hyperfine structure spectra.</span>

<span class="sd">.. moduleauthor:: Wouter Gins &lt;wouter.gins@kuleuven.be&gt;</span>
<span class="sd">.. moduleauthor:: Ruben de Groote &lt;ruben.degroote@kuleuven.be&gt;</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">from</span> <span class="nn">fractions</span> <span class="kn">import</span> <span class="n">Fraction</span>

<span class="kn">import</span> <span class="nn">lmfit</span> <span class="kn">as</span> <span class="nn">lm</span>
<span class="kn">from</span> <span class="nn">satlas.models.basemodel</span> <span class="kn">import</span> <span class="n">BaseModel</span>
<span class="kn">from</span> <span class="nn">satlas.models.summodel</span> <span class="kn">import</span> <span class="n">SumModel</span>
<span class="kn">from</span> <span class="nn">satlas.loglikelihood</span> <span class="kn">import</span> <span class="n">poisson_llh</span>
<span class="kn">from</span> <span class="nn">satlas.utilities</span> <span class="kn">import</span> <span class="n">poisson_interval</span>
<span class="kn">from</span> <span class="nn">satlas.utilities</span> <span class="kn">import</span> <span class="n">plot_line_ids</span>
<span class="kn">import</span> <span class="nn">satlas.profiles</span> <span class="kn">as</span> <span class="nn">p</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">scipy.optimize</span> <span class="kn">as</span> <span class="nn">optimize</span>
<span class="kn">from</span> <span class="nn">sympy.physics.wigner</span> <span class="kn">import</span> <span class="n">wigner_6j</span><span class="p">,</span> <span class="n">wigner_3j</span>

<span class="n">W6J</span> <span class="o">=</span> <span class="n">wigner_6j</span>
<span class="n">W3J</span> <span class="o">=</span> <span class="n">wigner_3j</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;HFSModel&#39;</span><span class="p">]</span>


<div class="viewcode-block" id="HFSModel"><a class="viewcode-back" href="../../../generated/satlas.models.hfsmodel.HFSModel.html#satlas.models.hfsmodel.HFSModel">[docs]</a><span class="k">class</span> <span class="nc">HFSModel</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>

    <span class="sd">r&quot;&quot;&quot;Constructs a HFS spectrum, consisting of different</span>
<span class="sd">    peaks described by a certain profile. The number of peaks is governed by</span>
<span class="sd">    the nuclear spin and the atomic spins of the levels.&quot;&quot;&quot;</span>

    <span class="n">__shapes__</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;gaussian&#39;</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">Gaussian</span><span class="p">,</span>
                  <span class="s1">&#39;lorentzian&#39;</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">Lorentzian</span><span class="p">,</span>
                  <span class="s1">&#39;crystalball&#39;</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">Crystalball</span><span class="p">,</span>
                  <span class="s1">&#39;voigt&#39;</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">Voigt</span><span class="p">,</span>
                  <span class="s1">&#39;pseudovoigt&#39;</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">PseudoVoigt</span><span class="p">}</span>

<div class="viewcode-block" id="HFSModel.__init__"><a class="viewcode-back" href="../../../generated/satlas.models.hfsmodel.HFSModel.html#satlas.models.hfsmodel.HFSModel.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">J</span><span class="p">,</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">centroid</span><span class="p">,</span> <span class="n">fwhm</span><span class="o">=</span><span class="p">[</span><span class="mf">50.0</span><span class="p">,</span> <span class="mf">50.0</span><span class="p">],</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">background_params</span><span class="o">=</span><span class="p">[</span><span class="mf">0.001</span><span class="p">],</span> <span class="n">shape</span><span class="o">=</span><span class="s1">&#39;voigt&#39;</span><span class="p">,</span> <span class="n">use_racah</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">use_saturation</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">saturation</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">shared_fwhm</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">sidepeak_params</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;Poisson&#39;</span><span class="p">:</span> <span class="mf">0.68</span><span class="p">,</span> <span class="s1">&#39;Offset&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span> <span class="n">crystalball_params</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Taillocation&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Tailamplitude&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span> <span class="n">pseudovoigt_params</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Eta&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}):</span>
        <span class="sd">&quot;&quot;&quot;Builds the HFS with the given atomic and nuclear information.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        I: float</span>
<span class="sd">            The nuclear spin.</span>
<span class="sd">        J: list of 2 floats</span>
<span class="sd">            The spins of the fine structure levels.</span>
<span class="sd">        ABC: list of 6 floats</span>
<span class="sd">            The hyperfine structure constants A, B and C for ground- and excited</span>
<span class="sd">            fine level. The list should be given as [A :sub:`lower`,</span>
<span class="sd">            A :sub:`upper`, B :sub:`lower`, B :sub:`upper`, C :sub:`upper`,</span>
<span class="sd">            C :sub:`lower`].</span>
<span class="sd">        centroid: float</span>
<span class="sd">            Centroid of the spectrum.</span>

<span class="sd">        Other parameters</span>
<span class="sd">        ----------------</span>
<span class="sd">        fwhm: float or list of 2 floats, optional</span>
<span class="sd">            Depending on the used shape, the FWHM is defined by one or two floats.</span>
<span class="sd">            Defaults to [50.0, 50.0]</span>
<span class="sd">        scale: float, optional</span>
<span class="sd">            Sets the strength of the spectrum, defaults to 1.0. Comparable to the</span>
<span class="sd">            amplitude of the spectrum.</span>
<span class="sd">        background_params: list of float, optional</span>
<span class="sd">            Sets the coefficients of the polynomial background to the given values.</span>
<span class="sd">            Order of polynomial is equal to the number of parameters given minus one.</span>
<span class="sd">            Highest order coefficient is the first element, etc.</span>
<span class="sd">        shape : string, optional</span>
<span class="sd">            Sets the transition shape. String is converted to lowercase. For</span>
<span class="sd">            possible values, see *HFSModel__shapes__*.keys()`.</span>
<span class="sd">            Defaults to Voigt if an incorrect value is supplied.</span>
<span class="sd">        use_racah: boolean, optional</span>
<span class="sd">            If True, fixes the relative peak intensities to the Racah intensities.</span>
<span class="sd">            Otherwise, gives them equal intensities and allows them to vary during</span>
<span class="sd">            fitting.</span>
<span class="sd">        use_saturation: boolean, optional</span>
<span class="sd">            If True, uses the saturation parameter to calculate relative intensities.</span>
<span class="sd">        saturation: float, optional</span>
<span class="sd">            If different than 0, calculate the saturation effect on the intensity of</span>
<span class="sd">            transition intensity. This is done by an exponential transition between</span>
<span class="sd">            Racah intensities and the saturated intensities.</span>
<span class="sd">        shared_fwhm: boolean, optional</span>
<span class="sd">            If True, the same FWHM is used for all peaks. Otherwise, give them all</span>
<span class="sd">            the same initial FWHM and let them vary during the fitting.</span>
<span class="sd">        sidepeak_params: dict</span>
<span class="sd">            A dictionary with the following keys and values:</span>

<span class="sd">            n: int</span>
<span class="sd">                Sets the number of sidepeaks that are present in the spectrum.</span>
<span class="sd">                Defaults to 0.</span>
<span class="sd">            poisson: float</span>
<span class="sd">                Sets the relative intensity of the first side peak. The intensity of the</span>
<span class="sd">                other sidepeaks is calculated from the Poisson-factor.</span>
<span class="sd">            offset: float</span>
<span class="sd">                Sets the distance (in MHz) of each sidepeak in the spectrum.</span>
<span class="sd">        crystalball_params: dict</span>
<span class="sd">            A dictionary with the following keys and values:</span>

<span class="sd">            tailamp: float</span>
<span class="sd">                Sets the relative amplitude of the tail for the Crystalball shape function.</span>
<span class="sd">            tailloc: float</span>
<span class="sd">                Sets the location of the tail for the Crystalball shape function.</span>
<span class="sd">        pseudovoigt_params: dict</span>
<span class="sd">            A dictionary with the following keys and values:</span>

<span class="sd">            Eta: float between 0 and 1</span>
<span class="sd">                Describes the mixing percentage of the Gaussian and Lorentzian shapes</span>
<span class="sd">            A: float</span>
<span class="sd">                Describes the asymmetry of the peak.</span>

<span class="sd">        Note</span>
<span class="sd">        ----</span>
<span class="sd">        The list of parameter keys is:</span>
<span class="sd">            * *FWHM* (only for profiles with one float for the FWHM)</span>
<span class="sd">            * *FWHMG* (only for profiles with two floats for the FWHM)</span>
<span class="sd">            * *FWHML* (only for profiles with two floats for the FWHM)</span>
<span class="sd">            * *Al*</span>
<span class="sd">            * *Au*</span>
<span class="sd">            * *Bl*</span>
<span class="sd">            * *Bu*</span>
<span class="sd">            * *Cl*</span>
<span class="sd">            * *Cu*</span>
<span class="sd">            * *Centroid*</span>
<span class="sd">            * *Background*</span>
<span class="sd">            * *Poisson* (only if the attribute *n* is greater than 0)</span>
<span class="sd">            * *Offset* (only if the attribute *n* is greater than 0)</span>
<span class="sd">            * *Amp* (with the correct labeling of the transition)</span>
<span class="sd">            * *scale*&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">HFSModel</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="n">shape</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">shape</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__shapes__</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;Given profile shape not yet supported.</span>
<span class="s2">            Defaulting to Voigt lineshape.&quot;&quot;&quot;</span><span class="p">)</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="s1">&#39;voigt&#39;</span>
            <span class="n">fwhm</span> <span class="o">=</span> <span class="p">[</span><span class="mf">50.0</span><span class="p">,</span> <span class="mf">50.0</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">I_value</span> <span class="o">=</span> <span class="p">{</span><span class="mf">0.0</span><span class="p">:</span> <span class="p">((</span><span class="bp">False</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                              <span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span>
                        <span class="mf">0.5</span><span class="p">:</span> <span class="p">((</span><span class="bp">True</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                              <span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span>
                        <span class="mf">1.0</span><span class="p">:</span> <span class="p">((</span><span class="bp">True</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                              <span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                              <span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">J_lower_value</span> <span class="o">=</span> <span class="p">{</span><span class="mf">0.0</span><span class="p">:</span> <span class="p">((</span><span class="bp">False</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span>
                              <span class="mf">0.5</span><span class="p">:</span> <span class="p">((</span><span class="bp">True</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                                    <span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span>
                              <span class="mf">1.0</span><span class="p">:</span> <span class="p">((</span><span class="bp">True</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                                    <span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                              <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">J_upper_value</span> <span class="o">=</span> <span class="p">{</span><span class="mf">0.0</span><span class="p">:</span> <span class="p">((</span><span class="bp">False</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span>
                              <span class="mf">0.5</span><span class="p">:</span> <span class="p">((</span><span class="bp">True</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                                    <span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span>
                              <span class="mf">1.0</span><span class="p">:</span> <span class="p">((</span><span class="bp">True</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                                    <span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                              <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="n">shape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_use_racah</span> <span class="o">=</span> <span class="n">use_racah</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_use_saturation</span> <span class="o">=</span> <span class="n">use_saturation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shared_fwhm</span> <span class="o">=</span> <span class="n">shared_fwhm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">I</span> <span class="o">=</span> <span class="n">I</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">J</span> <span class="o">=</span> <span class="n">J</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_F_levels</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_energy_coefficients</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_transitions</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_vary</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_constraints</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ratioA</span> <span class="o">=</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="s1">&#39;lower&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ratioB</span> <span class="o">=</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="s1">&#39;lower&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ratioC</span> <span class="o">=</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="s1">&#39;lower&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_roi</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_populate_params</span><span class="p">(</span><span class="n">ABC</span><span class="p">,</span> <span class="n">centroid</span><span class="p">,</span> <span class="n">fwhm</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">saturation</span><span class="p">,</span>
                              <span class="n">background_params</span><span class="p">,</span>
                              <span class="n">sidepeak_params</span><span class="p">,</span>
                              <span class="n">crystalball_params</span><span class="p">,</span>
                              <span class="n">pseudovoigt_params</span><span class="p">)</span>
</div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">locations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Contains the locations of the peaks.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_locations</span>

    <span class="nd">@locations.setter</span>
    <span class="k">def</span> <span class="nf">locations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">locations</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_locations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">locations</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parts</span><span class="p">,</span> <span class="n">locations</span><span class="p">):</span>
            <span class="n">p</span><span class="o">.</span><span class="n">mu</span> <span class="o">=</span> <span class="n">l</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">use_racah</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Boolean to set the behaviour to Racah intensities (True)</span>
<span class="sd">        or to individual amplitudes (False).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_racah</span>

    <span class="nd">@use_racah.setter</span>
    <span class="k">def</span> <span class="nf">use_racah</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_use_racah</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;Scale&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_racah</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_saturation</span>
        <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ftof</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;Amp&#39;</span> <span class="o">+</span> <span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">vary</span> <span class="o">=</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_use_racah</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_saturation</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">use_saturation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Boolean to set the behaviour to the saturation model (True)</span>
<span class="sd">        or not (False).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_saturation</span>

    <span class="nd">@use_saturation.setter</span>
    <span class="k">def</span> <span class="nf">use_saturation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_use_saturation</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;Saturation&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vary</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;Scale&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_racah</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_saturation</span>
        <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ftof</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;Amp&#39;</span> <span class="o">+</span> <span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">vary</span> <span class="o">=</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_use_racah</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_saturation</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">roi</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Tuple of (left, right)-limits between which at least one of</span>
<span class="sd">        the peaks has to be located. If the peaks are all outside this</span>
<span class="sd">        region, the calculation of the prior returns infinity. Defaults</span>
<span class="sd">        to (-np.inf, np.inf).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_roi</span>

    <span class="nd">@roi.setter</span>
    <span class="k">def</span> <span class="nf">roi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_roi</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">get_lnprior_mapping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="c1"># Implementation uses the &#39;fail early&#39; paradigm to speed up calculations.</span>
        <span class="c1"># First, the easiest checks to fail are made, followed by slower ones.</span>
        <span class="c1"># If a check is failed, -np.inf is returned immediately.</span>
        <span class="c1"># Check if at least one of the peaks lies within the region of interest</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">locations</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">locations</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="p">[</span><span class="mi">1</span><span class="p">])):</span>
            <span class="k">return</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">HFSModel</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_lnprior_mapping</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Instance of lmfit.Parameters object characterizing the</span>
<span class="sd">        shape of the HFS.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_variation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span>

    <span class="nd">@params.setter</span>
    <span class="k">def</span> <span class="nf">params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_params</span> <span class="o">=</span> <span class="n">params</span>
        <span class="c1"># When changing the parameters, the energies and</span>
        <span class="c1"># the locations have to be recalculated</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_energies</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_transition_locations</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_racah</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_saturation</span><span class="p">:</span>
            <span class="c1"># When not using set amplitudes, they need</span>
            <span class="c1"># to be changed after every iteration</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_amplitudes</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_saturation</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_transitional_amplitudes</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="c1"># Finally, the fwhm of each peak needs to be set</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_fwhm</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;crystalball&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parts</span><span class="p">:</span>
                <span class="n">part</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;Taillocation&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
                <span class="n">part</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;Tailamplitude&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;pseudovoigt&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">part</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ftof</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parts</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared_fwhm</span><span class="p">:</span>
                    <span class="n">part</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;Eta&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
                    <span class="n">part</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">part</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;Eta&#39;</span><span class="o">+</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
                    <span class="n">part</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="o">+</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>

    <span class="k">def</span> <span class="nf">_set_transitional_amplitudes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_transitional_intensities</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="s1">&#39;Saturation&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parts</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ftof</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="s1">&#39;Amp&#39;</span> <span class="o">+</span> <span class="n">l</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">v</span>
            <span class="n">p</span><span class="o">.</span><span class="n">amp</span> <span class="o">=</span> <span class="n">v</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ftof</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;List of transition labels, of the form *Flow__Fhigh* (half-integers</span>
<span class="sd">        have an underscore instead of a division sign), same ordering</span>
<span class="sd">        as given by the attribute :attr:`.locations`.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ftof</span>

    <span class="nd">@ftof.setter</span>
    <span class="k">def</span> <span class="nf">ftof</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ftof</span> <span class="o">=</span> <span class="n">value</span>

<div class="viewcode-block" id="HFSModel._calculate_energies"><a class="viewcode-back" href="../../../generated/hfsmodel/satlas.models.hfsmodel.HFSModel._calculate_energies.html#satlas.models.hfsmodel.HFSModel._calculate_energies">[docs]</a>    <span class="k">def</span> <span class="nf">_calculate_energies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">r&quot;&quot;&quot;The hyperfine addition to a central frequency (attribute *centroid*)</span>
<span class="sd">        for a specific level is calculated. The formula comes from</span>
<span class="sd">        :cite:`Schwartz1955` and in a simplified form, reads</span>

<span class="sd">        .. math::</span>
<span class="sd">            C_F &amp;= F(F+1) - I(I+1) - J(J+1)</span>

<span class="sd">            D_F &amp;= \frac{3 C_F (C_F + 1) - 4 I (I + 1) J (J + 1)}{2 I (2 I - 1)</span>
<span class="sd">            J (2 J - 1)}</span>

<span class="sd">            E_F &amp;= \frac{10 (\frac{C_F}{2})^3 + 20(\frac{C_F}{2})^2 + C_F(-3I(I</span>
<span class="sd">            + 1)J(J + 1) + I(I + 1) + J(J + 1) + 3) - 5I(I + 1)J(J + 1)}{I(I -</span>
<span class="sd">            1)(2I - 1)J(J - 1)(2J - 1)}</span>

<span class="sd">            E &amp;= centroid + \frac{A C_F}{2} + \frac{B D_F}{4} + C E_F</span>

<span class="sd">        A, B and C are the dipole, quadrupole and octupole hyperfine</span>
<span class="sd">        parameters. Octupole contributions are calculated when both the</span>
<span class="sd">        nuclear and electronic spin is greater than 1, quadrupole contributions</span>
<span class="sd">        when they are greater than 1/2, and dipole contributions when they are</span>
<span class="sd">        greater than 0.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        level: int, 0 or 1</span>
<span class="sd">            Integer referring to the lower (0) level, or the upper (1) level.</span>
<span class="sd">        F: integer or half-integer</span>
<span class="sd">            F-quantum number for which the hyperfine-corrected energy has to be</span>
<span class="sd">            calculated.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        energy: float</span>
<span class="sd">            Energy in MHz.&quot;&quot;&quot;</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_lower</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="s1">&#39;Al&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                      <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_upper</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="s1">&#39;Au&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_lower</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="s1">&#39;Bl&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                      <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_upper</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="s1">&#39;Bu&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_lower</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="s1">&#39;Cl&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                      <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_upper</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="s1">&#39;Cu&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">centr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_lower</span><span class="p">),</span>
                          <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_upper</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="s1">&#39;Centroid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">energies</span> <span class="o">=</span> <span class="n">centr</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">C</span> <span class="o">*</span> <span class="n">A</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">D</span> <span class="o">*</span> <span class="n">B</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">E</span> <span class="o">*</span> <span class="n">C</span>
</div>
    <span class="k">def</span> <span class="nf">_calculate_transition_locations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">locations</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="p">[</span><span class="n">ind_high</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="p">[</span><span class="n">ind_low</span><span class="p">]</span> <span class="k">for</span> <span class="p">(</span><span class="n">ind_low</span><span class="p">,</span> <span class="n">ind_high</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">transition_indices</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_set_amplitudes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parts</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ftof</span><span class="p">):</span>
            <span class="n">p</span><span class="o">.</span><span class="n">amp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="s1">&#39;Amp&#39;</span> <span class="o">+</span> <span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>

    <span class="k">def</span> <span class="nf">_set_fwhm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;voigt&#39;</span><span class="p">:</span>
            <span class="n">fwhm</span> <span class="o">=</span> <span class="p">[[</span><span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="s1">&#39;FWHMG&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="s1">&#39;FWHML&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ftof</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared_fwhm</span> <span class="k">else</span> <span class="p">[[</span><span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="s1">&#39;FWHMG&#39;</span> <span class="o">+</span> <span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="s1">&#39;FWHML&#39;</span> <span class="o">+</span> <span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">]</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ftof</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fwhm</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="s1">&#39;FWHM&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ftof</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared_fwhm</span> <span class="k">else</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="s1">&#39;FWHM&#39;</span> <span class="o">+</span> <span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ftof</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parts</span><span class="p">,</span> <span class="n">fwhm</span><span class="p">):</span>
            <span class="n">p</span><span class="o">.</span><span class="n">fwhm</span> <span class="o">=</span> <span class="n">f</span>

    <span class="c1">####################################</span>
    <span class="c1">#      INITIALIZATION METHODS      #</span>
    <span class="c1">####################################</span>

    <span class="k">def</span> <span class="nf">_populate_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">centroid</span><span class="p">,</span> <span class="n">fwhm</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">saturation</span><span class="p">,</span> <span class="n">background_params</span><span class="p">,</span> <span class="n">sidepeak_params</span><span class="p">,</span> <span class="n">crystalball_params</span><span class="p">,</span> <span class="n">pseudovoigt_params</span><span class="p">):</span>
        <span class="c1"># Prepares the params attribute with the initial values</span>
        <span class="n">par</span> <span class="o">=</span> <span class="n">lm</span><span class="o">.</span><span class="n">Parameters</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;voigt&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared_fwhm</span><span class="p">:</span>
                <span class="n">par</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;FWHM&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">fwhm</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;pseudovoigt&#39;</span><span class="p">:</span>
                    <span class="n">Eta</span> <span class="o">=</span> <span class="n">pseudovoigt_params</span><span class="p">[</span><span class="s1">&#39;Eta&#39;</span><span class="p">]</span>
                    <span class="n">A</span> <span class="o">=</span> <span class="n">pseudovoigt_params</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">]</span>
                    <span class="n">par</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;Eta&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">Eta</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">par</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">tailamp</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fwhm</span> <span class="o">=</span> <span class="p">[</span><span class="n">fwhm</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ftof</span><span class="p">))]</span>
                <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ftof</span><span class="p">,</span> <span class="n">fwhm</span><span class="p">):</span>
                    <span class="n">par</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;FWHM&#39;</span> <span class="o">+</span> <span class="n">label</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">val</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;pseudovoigt&#39;</span><span class="p">:</span>
                        <span class="n">Eta</span> <span class="o">=</span> <span class="n">pseudovoigt_params</span><span class="p">[</span><span class="s1">&#39;Eta&#39;</span><span class="p">]</span>
                        <span class="n">A</span> <span class="o">=</span> <span class="n">pseudovoigt_params</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">]</span>
                        <span class="n">par</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;Eta&#39;</span> <span class="o">+</span> <span class="n">label</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">Eta</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">par</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;A&#39;</span> <span class="o">+</span> <span class="n">label</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">A</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared_fwhm</span><span class="p">:</span>
                <span class="n">par</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;FWHMG&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">fwhm</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vary</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">par</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;FWHML&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">fwhm</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">vary</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">val</span> <span class="o">=</span> <span class="mf">0.5346</span> <span class="o">*</span> <span class="n">fwhm</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">0.2166</span> <span class="o">*</span> <span class="n">fwhm</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">fwhm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">par</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;TotalFWHM&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">val</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                        <span class="n">expr</span><span class="o">=</span><span class="s1">&#39;0.5346*FWHML+(0.2166*FWHML**2+FWHMG**2)**0.5&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fwhm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fwhm</span><span class="p">)</span>
                <span class="n">fwhm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">fwhm</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fwhm</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ftof</span><span class="p">))])</span>
                <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ftof</span><span class="p">,</span> <span class="n">fwhm</span><span class="p">):</span>
                    <span class="n">par</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;FWHMG&#39;</span> <span class="o">+</span> <span class="n">label</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vary</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">par</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;FWHML&#39;</span> <span class="o">+</span> <span class="n">label</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">vary</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="mf">0.5346</span> <span class="o">*</span> <span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">0.2166</span> <span class="o">*</span> <span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span>
                                                    <span class="o">+</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
                    <span class="n">par</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;TotalFWHM&#39;</span> <span class="o">+</span> <span class="n">label</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">val</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                            <span class="n">expr</span><span class="o">=</span><span class="s1">&#39;0.5346*FWHML&#39;</span> <span class="o">+</span> <span class="n">label</span> <span class="o">+</span>
                                 <span class="s1">&#39;+(0.2166*FWHML&#39;</span> <span class="o">+</span> <span class="n">label</span> <span class="o">+</span>
                                 <span class="s1">&#39;**2+FWHMG&#39;</span> <span class="o">+</span> <span class="n">label</span> <span class="o">+</span> <span class="s1">&#39;**2)**0.5&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;crystalball&#39;</span><span class="p">:</span>
            <span class="n">taillocation</span> <span class="o">=</span> <span class="n">crystalball_params</span><span class="p">[</span><span class="s1">&#39;Taillocation&#39;</span><span class="p">]</span>
            <span class="n">tailamplitude</span> <span class="o">=</span> <span class="n">crystalball_params</span><span class="p">[</span><span class="s1">&#39;Tailamplitude&#39;</span><span class="p">]</span>
            <span class="n">par</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;Taillocation&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">taillocation</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">par</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;Tailamplitude&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">tailamplitude</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parts</span><span class="p">:</span>
                <span class="n">part</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">taillocation</span>
                <span class="n">part</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="n">tailamplitude</span>

        <span class="n">par</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;Scale&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_racah</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_saturation</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">par</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;Saturation&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">saturation</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_saturation</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_saturation</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">amps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_transitional_intensities</span><span class="p">(</span><span class="n">saturation</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">amp</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ftof</span><span class="p">,</span> <span class="n">amps</span><span class="p">):</span>
            <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Amp&#39;</span> <span class="o">+</span> <span class="n">label</span>
            <span class="n">par</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">amp</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">use_racah</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_saturation</span><span class="p">),</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">par</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;Al&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">ABC</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vary</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">par</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;Au&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">ABC</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">vary</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">par</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;Bl&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">ABC</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">vary</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">par</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;Bu&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">ABC</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">vary</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">par</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;Cl&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">ABC</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">vary</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">par</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;Cu&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">ABC</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">vary</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="n">ratios</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ratioA</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ratioB</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ratioC</span><span class="p">)</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;Al&#39;</span><span class="p">,</span> <span class="s1">&#39;Au&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;Bl&#39;</span><span class="p">,</span> <span class="s1">&#39;Bu&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;Cl&#39;</span><span class="p">,</span> <span class="s1">&#39;Cu&#39;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">r</span><span class="p">,</span> <span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">u</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ratios</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;lower&#39;</span><span class="p">:</span>
                    <span class="n">fixed</span><span class="p">,</span> <span class="n">free</span> <span class="o">=</span> <span class="n">l</span><span class="p">,</span> <span class="n">u</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fixed</span><span class="p">,</span> <span class="n">free</span> <span class="o">=</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span>
                <span class="n">par</span><span class="p">[</span><span class="n">fixed</span><span class="p">]</span><span class="o">.</span><span class="n">expr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;*&#39;</span> <span class="o">+</span> <span class="n">free</span>
                <span class="n">par</span><span class="p">[</span><span class="n">fixed</span><span class="p">]</span><span class="o">.</span><span class="n">vary</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="n">par</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;Centroid&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">centroid</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">background_params</span><span class="p">))):</span>
            <span class="n">par</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;Background&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">value</span><span class="o">=</span><span class="n">background_params</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">vary</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">n</span><span class="p">,</span> <span class="n">poisson</span><span class="p">,</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">sidepeak_params</span><span class="p">[</span><span class="s1">&#39;N&#39;</span><span class="p">],</span> <span class="n">sidepeak_params</span><span class="p">[</span><span class="s1">&#39;Poisson&#39;</span><span class="p">],</span> <span class="n">sidepeak_params</span><span class="p">[</span><span class="s1">&#39;Offset&#39;</span><span class="p">]</span>
        <span class="n">par</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;N&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">par</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;Poisson&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">poisson</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">par</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;Offset&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">offset</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_variation</span><span class="p">(</span><span class="n">par</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_ratios</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">par</span><span class="p">):</span>
        <span class="c1"># Process the set ratio&#39;s for the hyperfine parameters.</span>
        <span class="n">ratios</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ratioA</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ratioB</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ratioC</span><span class="p">)</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;Al&#39;</span><span class="p">,</span> <span class="s1">&#39;Au&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;Bl&#39;</span><span class="p">,</span> <span class="s1">&#39;Bu&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;Cl&#39;</span><span class="p">,</span> <span class="s1">&#39;Cu&#39;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">r</span><span class="p">,</span> <span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">u</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ratios</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;lower&#39;</span><span class="p">:</span>
                    <span class="n">fixed</span><span class="p">,</span> <span class="n">free</span> <span class="o">=</span> <span class="n">l</span><span class="p">,</span> <span class="n">u</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fixed</span><span class="p">,</span> <span class="n">free</span> <span class="o">=</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span>
                <span class="n">par</span><span class="p">[</span><span class="n">fixed</span><span class="p">]</span><span class="o">.</span><span class="n">expr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;*&#39;</span> <span class="o">+</span> <span class="n">free</span>
                <span class="n">par</span><span class="p">[</span><span class="n">fixed</span><span class="p">]</span><span class="o">.</span><span class="n">vary</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="n">par</span><span class="p">[</span><span class="n">free</span><span class="p">]</span><span class="o">.</span><span class="n">vary</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="n">par</span>

    <span class="k">def</span> <span class="nf">_check_variation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">par</span><span class="p">):</span>
        <span class="n">par</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">HFSModel</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_check_variation</span><span class="p">(</span><span class="n">par</span><span class="p">)</span>
        <span class="c1"># Make sure the variations in the params are set correctly.</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vary</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">par</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">par</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">vary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vary</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="n">par</span><span class="p">[</span><span class="s1">&#39;N&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vary</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">I</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">I_value</span><span class="p">:</span>
            <span class="n">Al</span><span class="p">,</span> <span class="n">Au</span><span class="p">,</span> <span class="n">Bl</span><span class="p">,</span> <span class="n">Bu</span><span class="p">,</span> <span class="n">Cl</span><span class="p">,</span> <span class="n">Cu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">I_value</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">I</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">Al</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">par</span><span class="p">[</span><span class="s1">&#39;Al&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vary</span><span class="p">,</span> <span class="n">par</span><span class="p">[</span><span class="s1">&#39;Al&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">Al</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">Au</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">par</span><span class="p">[</span><span class="s1">&#39;Au&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vary</span><span class="p">,</span> <span class="n">par</span><span class="p">[</span><span class="s1">&#39;Au&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">Au</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">Bl</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">par</span><span class="p">[</span><span class="s1">&#39;Bl&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vary</span><span class="p">,</span> <span class="n">par</span><span class="p">[</span><span class="s1">&#39;Bl&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">Bl</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">Bu</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">par</span><span class="p">[</span><span class="s1">&#39;Bu&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vary</span><span class="p">,</span> <span class="n">par</span><span class="p">[</span><span class="s1">&#39;Bu&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">Bu</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">Cl</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">par</span><span class="p">[</span><span class="s1">&#39;Cl&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vary</span><span class="p">,</span> <span class="n">par</span><span class="p">[</span><span class="s1">&#39;Cl&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">Cl</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">Cu</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">par</span><span class="p">[</span><span class="s1">&#39;Cu&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vary</span><span class="p">,</span> <span class="n">par</span><span class="p">[</span><span class="s1">&#39;Cu&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">Cu</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">J</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">J_lower_value</span><span class="p">:</span>
            <span class="n">Al</span><span class="p">,</span> <span class="n">Bl</span><span class="p">,</span> <span class="n">Cl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">J_lower_value</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">J</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">Al</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">par</span><span class="p">[</span><span class="s1">&#39;Al&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vary</span><span class="p">,</span> <span class="n">par</span><span class="p">[</span><span class="s1">&#39;Al&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">Al</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">Bl</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">par</span><span class="p">[</span><span class="s1">&#39;Bl&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vary</span><span class="p">,</span> <span class="n">par</span><span class="p">[</span><span class="s1">&#39;Bl&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">Bl</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">Cl</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">par</span><span class="p">[</span><span class="s1">&#39;Cl&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vary</span><span class="p">,</span> <span class="n">par</span><span class="p">[</span><span class="s1">&#39;Cl&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">Cl</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">J</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">num_lower</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">J_upper_value</span><span class="p">:</span>
            <span class="n">Au</span><span class="p">,</span> <span class="n">Bu</span><span class="p">,</span> <span class="n">Cu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">J_upper_value</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">J</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">num_lower</span><span class="p">]]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">Au</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">par</span><span class="p">[</span><span class="s1">&#39;Au&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vary</span><span class="p">,</span> <span class="n">par</span><span class="p">[</span><span class="s1">&#39;Au&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">Au</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">Bu</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">par</span><span class="p">[</span><span class="s1">&#39;Bu&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vary</span><span class="p">,</span> <span class="n">par</span><span class="p">[</span><span class="s1">&#39;Bu&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">Bu</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">Cu</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">par</span><span class="p">[</span><span class="s1">&#39;Cu&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vary</span><span class="p">,</span> <span class="n">par</span><span class="p">[</span><span class="s1">&#39;Cu&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">Cu</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constraints</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">bound</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constraints</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">bound</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;min&#39;</span><span class="p">:</span>
                    <span class="n">par</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">min</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constraints</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">bound</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">bound</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;max&#39;</span><span class="p">:</span>
                    <span class="n">par</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constraints</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">bound</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">pass</span>
        <span class="k">return</span> <span class="n">par</span>

    <span class="k">def</span> <span class="nf">_calculate_F_levels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">F1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">I</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">J</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="bp">self</span><span class="o">.</span><span class="n">I</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">J</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_lower</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">F1</span><span class="p">)</span>
        <span class="n">F2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">I</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">J</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="bp">self</span><span class="o">.</span><span class="n">I</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">J</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_upper</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">F2</span><span class="p">)</span>
        <span class="n">F</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">F1</span><span class="p">,</span> <span class="n">F2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">J</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">F1</span><span class="p">))</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">J</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                           <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">F2</span><span class="p">))</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">J</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">F</span> <span class="o">=</span> <span class="n">F</span>

    <span class="k">def</span> <span class="nf">_calculate_transitions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">f_f</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">amps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">sat_amp</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">F1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">num_lower</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">F2</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">num_lower</span><span class="p">:]):</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">F2</span> <span class="o">-</span> <span class="n">F1</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">F2</span> <span class="o">==</span> <span class="n">F1</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
                    <span class="n">sat_amp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">F1</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">j</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_lower</span>
                    <span class="n">intensity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_racah_intensity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">J</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                                               <span class="bp">self</span><span class="o">.</span><span class="n">J</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
                                                               <span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                                               <span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">intensity</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">amps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">intensity</span><span class="p">)</span>
                        <span class="n">indices</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">])</span>
                        <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                        <span class="n">temp</span> <span class="o">=</span> <span class="n">Fraction</span><span class="p">(</span><span class="n">F1</span><span class="p">)</span><span class="o">.</span><span class="n">limit_denominator</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">temp</span><span class="o">.</span><span class="n">denominator</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">temp</span><span class="o">.</span><span class="n">numerator</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">temp</span><span class="o">.</span><span class="n">numerator</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">temp</span><span class="o">.</span><span class="n">denominator</span><span class="p">)</span>
                        <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;__&#39;</span>
                        <span class="n">temp</span> <span class="o">=</span> <span class="n">Fraction</span><span class="p">(</span><span class="n">F2</span><span class="p">)</span><span class="o">.</span><span class="n">limit_denominator</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">temp</span><span class="o">.</span><span class="n">denominator</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">temp</span><span class="o">.</span><span class="n">numerator</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">temp</span><span class="o">.</span><span class="n">numerator</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">temp</span><span class="o">.</span><span class="n">denominator</span><span class="p">)</span>
                        <span class="n">f_f</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ftof</span> <span class="o">=</span> <span class="n">f_f</span>  <span class="c1"># Stores the labels of all transitions, in order</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transition_indices</span> <span class="o">=</span> <span class="n">indices</span>  <span class="c1"># Stores the indices in the F and energy arrays for the transition</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">racah_amplitudes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">amps</span><span class="p">)</span>  <span class="c1"># Sets the initial amplitudes to the Racah intensities</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">racah_amplitudes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">racah_amplitudes</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">racah_amplitudes</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">saturated_amplitudes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sat_amp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">saturated_amplitudes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">saturated_amplitudes</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">saturated_amplitudes</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">parts</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__shapes__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">](</span><span class="n">amp</span><span class="o">=</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">racah_amplitudes</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_calculate_transitional_intensities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">s</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">racah_amplitudes</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">saturated_amplitudes</span>
            <span class="n">rac</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">racah_amplitudes</span>
            <span class="n">transitional</span> <span class="o">=</span> <span class="o">-</span><span class="n">sat</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">expm1</span><span class="p">(</span><span class="o">-</span><span class="n">rac</span> <span class="o">*</span> <span class="n">s</span> <span class="o">/</span> <span class="n">sat</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">transitional</span> <span class="o">/</span> <span class="n">transitional</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_calculate_racah_intensity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">J1</span><span class="p">,</span> <span class="n">J2</span><span class="p">,</span> <span class="n">F1</span><span class="p">,</span> <span class="n">F2</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">((</span><span class="mi">2</span> <span class="o">*</span> <span class="n">F1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">F2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> \
                     <span class="n">W6J</span><span class="p">(</span><span class="n">J2</span><span class="p">,</span> <span class="n">F2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">I</span><span class="p">,</span> <span class="n">F1</span><span class="p">,</span> <span class="n">J1</span><span class="p">,</span> <span class="n">order</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># DO NOT REMOVE CAST TO FLOAT!!!</span>

    <span class="k">def</span> <span class="nf">_calculate_energy_coefficients</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Since I, J and F do not change, these factors can be calculated once</span>
        <span class="c1"># and then stored.</span>
        <span class="n">I</span><span class="p">,</span> <span class="n">J</span><span class="p">,</span> <span class="n">F</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">I</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">J</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">F</span>
        <span class="n">C</span> <span class="o">=</span> <span class="p">(</span><span class="n">F</span><span class="o">*</span><span class="p">(</span><span class="n">F</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">I</span><span class="o">*</span><span class="p">(</span><span class="n">I</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">J</span><span class="o">*</span><span class="p">(</span><span class="n">J</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="n">J</span><span class="o">/</span><span class="n">J</span><span class="p">)</span> <span class="k">if</span> <span class="n">I</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span> <span class="o">*</span> <span class="n">J</span>  <span class="c1">#*(J/J) is a dirty trick to avoid checking for J=0</span>
        <span class="n">D</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">C</span><span class="o">*</span><span class="p">(</span><span class="n">C</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="o">*</span><span class="n">I</span><span class="o">*</span><span class="p">(</span><span class="n">I</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">J</span><span class="o">*</span><span class="p">(</span><span class="n">J</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">I</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">I</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">J</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">J</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">E</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="o">*</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="n">C</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span> <span class="o">+</span> <span class="mi">20</span><span class="o">*</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="n">C</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">C</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="o">*</span><span class="n">I</span><span class="o">*</span><span class="p">(</span><span class="n">I</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">J</span><span class="o">*</span><span class="p">(</span><span class="n">J</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">I</span><span class="o">*</span><span class="p">(</span><span class="n">I</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">J</span><span class="o">*</span><span class="p">(</span><span class="n">J</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="mi">5</span><span class="o">*</span><span class="n">I</span><span class="o">*</span><span class="p">(</span><span class="n">I</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">J</span><span class="o">*</span><span class="p">(</span><span class="n">J</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">I</span><span class="o">*</span><span class="p">(</span><span class="n">I</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">I</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">J</span><span class="o">*</span><span class="p">(</span><span class="n">J</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">J</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">C</span><span class="p">),</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">C</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">D</span><span class="p">),</span> <span class="mf">0.25</span> <span class="o">*</span> <span class="n">D</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">E</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">E</span><span class="p">),</span> <span class="n">E</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">C</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">D</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">E</span> <span class="o">=</span> <span class="n">C</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">E</span>

    <span class="c1">##########################</span>
    <span class="c1">#      USER METHODS      #</span>
    <span class="c1">##########################</span>
<div class="viewcode-block" id="HFSModel.fix_ratio"><a class="viewcode-back" href="../../../generated/hfsmodel/satlas.models.hfsmodel.HFSModel.fix_ratio.html#satlas.models.hfsmodel.HFSModel.fix_ratio">[docs]</a>    <span class="k">def</span> <span class="nf">fix_ratio</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="s1">&#39;upper&#39;</span><span class="p">,</span> <span class="n">parameter</span><span class="o">=</span><span class="s1">&#39;A&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fixes the ratio for a given hyperfine parameter to the given value.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        value: float</span>
<span class="sd">            Value to which the ratio is set</span>
<span class="sd">        target: {&#39;upper&#39;, &#39;lower&#39;}</span>
<span class="sd">            Sets the target level. If &#39;upper&#39;, the upper parameter is</span>
<span class="sd">            calculated as lower * ratio, &#39;lower&#39; calculates the lower</span>
<span class="sd">            parameter as upper * ratio.</span>
<span class="sd">        parameter: {&#39;A&#39;, &#39;B&#39;, &#39;C&#39;}</span>
<span class="sd">            Selects which hyperfine parameter to set the ratio for.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">target</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="s1">&#39;upper&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;Target must be &#39;lower&#39; or &#39;upper&#39;.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">parameter</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;Parameter must be &#39;A&#39;, &#39;B&#39; or &#39;C&#39;.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">parameter</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;a&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ratioA</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">parameter</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ratioB</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">parameter</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ratioC</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_ratios</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">)</span>

    <span class="c1">###########################</span>
    <span class="c1">#      MAGIC METHODS      #</span>
    <span class="c1">###########################</span>
</div>
<div class="viewcode-block" id="HFSModel.__call__"><a class="viewcode-back" href="../../../generated/hfsmodel/satlas.models.hfsmodel.HFSModel.__call__.html#satlas.models.hfsmodel.HFSModel.__call__">[docs]</a>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the response for frequency *x* (in MHz) of the spectrum.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : float or array_like</span>
<span class="sd">            Frequency in MHz</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float or NumPy array</span>
<span class="sd">            Response of the spectrum for each value of *x*.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="s1">&#39;N&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="s1">&#39;N&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="s1">&#39;Poisson&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">**</span> <span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="nb">sum</span><span class="p">([</span><span class="n">prof</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">i</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="s1">&#39;Offset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
                                                                <span class="k">for</span> <span class="n">prof</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parts</span><span class="p">]))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">factorial</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="s1">&#39;Scale&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="s1">&#39;Scale&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> <span class="nb">sum</span><span class="p">([</span><span class="n">prof</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">prof</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parts</span><span class="p">])</span>
        <span class="n">background_params</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="n">par_name</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">par_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span> <span class="k">if</span> <span class="n">par_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;Background&#39;</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">s</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">background_params</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>

    <span class="c1">###############################</span>
    <span class="c1">#      PLOTTING ROUTINES      #</span>
    <span class="c1">###############################</span>
</div>
<div class="viewcode-block" id="HFSModel.plot"><a class="viewcode-back" href="../../../generated/hfsmodel/satlas.models.hfsmodel.HFSModel.plot.html#satlas.models.hfsmodel.HFSModel.plot">[docs]</a>    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
             <span class="n">no_of_points</span><span class="o">=</span><span class="mi">10</span><span class="o">**</span><span class="mi">3</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">plot_kws</span><span class="o">=</span><span class="p">{}):</span>
        <span class="sd">&quot;&quot;&quot;Plot the hfs, possibly on top of experimental data.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x: array</span>
<span class="sd">            Experimental x-data. If None, a suitable region around</span>
<span class="sd">            the peaks is chosen to plot the hfs.</span>
<span class="sd">        y: array</span>
<span class="sd">            Experimental y-data.</span>
<span class="sd">        yerr: array or dict(&#39;high&#39;: array, &#39;low&#39;: array)</span>
<span class="sd">            Experimental errors on y.</span>
<span class="sd">        no_of_points: int</span>
<span class="sd">            Number of points to use for the plot of the hfs if</span>
<span class="sd">            experimental data is given.</span>
<span class="sd">        ax: matplotlib axes object</span>
<span class="sd">            If provided, plots on this axis.</span>
<span class="sd">        show: boolean</span>
<span class="sd">            If True, the plot will be shown at the end.</span>
<span class="sd">        plot_kws: dictionary</span>
<span class="sd">            A dictionary possibly containing the following entries:</span>

<span class="sd">            legend: string, optional</span>
<span class="sd">                If given, an entry in the legend will be made for the spectrum.</span>
<span class="sd">            data_legend: string, optional</span>
<span class="sd">                If given, an entry in the legend will be made for the experimental</span>
<span class="sd">                data.</span>
<span class="sd">            xlabel: string, optional</span>
<span class="sd">                If given, sets the xlabel to this string. Defaults to &#39;Frequency (MHz)&#39;.</span>
<span class="sd">            ylabel: string, optional</span>
<span class="sd">                If given, sets the ylabel to this string. Defaults to &#39;Counts&#39;.</span>
<span class="sd">            model: boolean, optional</span>
<span class="sd">                If given, the region around the fitted line will be shaded, with</span>
<span class="sd">                the luminosity indicating the pmf of the Poisson</span>
<span class="sd">                distribution characterized by the value of the fit. Note that</span>
<span class="sd">                the argument *yerr* is ignored if *model* is True.</span>
<span class="sd">            normalized: boolean, optional</span>
<span class="sd">                If True, the data and fit are plotted normalized such that the highest</span>
<span class="sd">                data point is one.</span>
<span class="sd">            background: boolean, optional</span>
<span class="sd">                If True, the background is used, otherwise the pure spectrum is plotted.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        fig, ax: matplotlib figure and axis</span>
<span class="sd">            Figure and axis used for the plotting.&quot;&quot;&quot;</span>

        <span class="n">kws</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">plot_kws</span><span class="p">)</span>
        <span class="n">legend</span> <span class="o">=</span> <span class="n">kws</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;legend&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,)</span>
        <span class="n">data_legend</span> <span class="o">=</span> <span class="n">kws</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;data_legend&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">xlabel</span> <span class="o">=</span> <span class="n">kws</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;xlabel&#39;</span><span class="p">,</span> <span class="s1">&#39;Frequency (MHz)&#39;</span><span class="p">)</span>
        <span class="n">ylabel</span> <span class="o">=</span> <span class="n">kws</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;ylabel&#39;</span><span class="p">,</span> <span class="s1">&#39;Counts&#39;</span><span class="p">,)</span>
        <span class="n">indicate</span> <span class="o">=</span> <span class="n">kws</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;indicate&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">kws</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="n">colormap</span> <span class="o">=</span> <span class="n">kws</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;colormap&#39;</span><span class="p">,</span> <span class="s1">&#39;bone_r&#39;</span><span class="p">,)</span>
        <span class="n">normalized</span> <span class="o">=</span> <span class="n">kws</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;normalized&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="n">distance</span> <span class="o">=</span> <span class="n">kws</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;distance&#39;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
        <span class="n">background</span> <span class="o">=</span> <span class="n">kws</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;background&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span>
        <span class="n">toReturn</span> <span class="o">=</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span>
        <span class="n">color_points</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">_get_lines</span><span class="o">.</span><span class="n">prop_cycler</span><span class="p">)[</span><span class="s1">&#39;color&#39;</span><span class="p">]</span>
        <span class="n">color_lines</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">_get_lines</span><span class="o">.</span><span class="n">prop_cycler</span><span class="p">)[</span><span class="s1">&#39;color&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">ranges</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">fwhm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">fwhm</span>

            <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">locations</span><span class="p">:</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">pos</span> <span class="o">-</span> <span class="n">distance</span> <span class="o">*</span> <span class="n">fwhm</span><span class="p">,</span>
                                <span class="n">pos</span> <span class="o">+</span> <span class="n">distance</span> <span class="o">*</span> <span class="n">fwhm</span><span class="p">,</span>
                                <span class="mi">2</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="mi">0</span><span class="o">+</span><span class="mi">50</span><span class="p">)</span>
                <span class="n">ranges</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
            <span class="n">superx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">ranges</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">superx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="nb">int</span><span class="p">(</span><span class="n">no_of_points</span><span class="p">))</span>

        <span class="k">if</span> <span class="s1">&#39;sigma_x&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">:</span>
            <span class="n">xerr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="s1">&#39;sigma_x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">xerr</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">normalized</span><span class="p">:</span>
            <span class="n">norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
            <span class="n">y</span><span class="p">,</span><span class="n">yerr</span> <span class="o">=</span> <span class="n">y</span><span class="o">/</span><span class="n">norm</span><span class="p">,</span><span class="n">yerr</span><span class="o">/</span><span class="n">norm</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">norm</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">model</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="p">[</span><span class="n">yerr</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">],</span> <span class="n">yerr</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">]],</span>
                                <span class="n">xerr</span><span class="o">=</span><span class="n">xerr</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">data_legend</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color_points</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">yerr</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">data_legend</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color_points</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color_points</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">model</span><span class="p">:</span>
            <span class="n">superx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">superx</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">superx</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="nb">len</span><span class="p">(</span><span class="n">superx</span><span class="p">))</span>
            <span class="nb">range</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">locations</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">locations</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
            <span class="k">if</span> <span class="nb">range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nb">range</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">max_counts</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="nb">range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">max_counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="o">-</span><span class="n">optimize</span><span class="o">.</span><span class="n">brute</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="bp">self</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="p">(</span><span class="nb">range</span><span class="p">,),</span> <span class="n">full_output</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">Ns</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">finish</span><span class="o">=</span><span class="n">optimize</span><span class="o">.</span><span class="n">fmin</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">min_counts</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="n">par_name</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">par_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span> <span class="k">if</span> <span class="n">par_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;Background&#39;</span><span class="p">)][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">min_counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">min_counts</span> <span class="o">-</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">min_counts</span> <span class="o">**</span> <span class="mf">0.5</span><span class="p">))</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">min_counts</span><span class="p">,</span> <span class="n">max_counts</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">max_counts</span> <span class="o">**</span> <span class="mf">0.5</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">superx</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
            <span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">poisson</span><span class="p">(</span><span class="bp">self</span><span class="p">(</span><span class="n">x</span><span class="p">))</span><span class="o">.</span><span class="n">pmf</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

            <span class="n">z</span> <span class="o">=</span> <span class="n">z</span> <span class="o">/</span> <span class="n">z</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">y</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">y</span><span class="o">.</span><span class="n">max</span><span class="p">()),</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">colormap</span><span class="p">))</span>
            <span class="n">line</span><span class="p">,</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">superx</span><span class="p">,</span> <span class="bp">self</span><span class="p">(</span><span class="n">superx</span><span class="p">)</span> <span class="o">/</span> <span class="n">norm</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">legend</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color_lines</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">background</span><span class="p">:</span>
                <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">superx</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">background_params</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="n">par_name</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">par_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span> <span class="k">if</span> <span class="n">par_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;Background&#39;</span><span class="p">)]</span>
                <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">superx</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">background_params</span><span class="p">,</span> <span class="n">superx</span><span class="p">)</span>
            <span class="n">line</span><span class="p">,</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">superx</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">legend</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color_lines</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">superx</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">superx</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">indicate</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">background</span><span class="p">:</span>
                <span class="n">Y</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">locations</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">background_params</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="n">par_name</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">par_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span> <span class="k">if</span> <span class="n">par_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;Background&#39;</span><span class="p">)]</span>
                <span class="n">Y</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">locations</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">background_params</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">locations</span><span class="p">)</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ftof</span><span class="p">:</span>
                <span class="n">lab</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;__&#39;</span><span class="p">)</span>
                <span class="n">lableft</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lab</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">))</span>
                <span class="n">labright</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lab</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">))</span>
                <span class="n">lab</span> <span class="o">=</span> <span class="s1">&#39;$&#39;</span> <span class="o">+</span> <span class="n">lableft</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">rightarrow&#39;</span> <span class="o">+</span> <span class="n">labright</span> <span class="o">+</span> <span class="s1">&#39;$&#39;</span>
                <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lab</span><span class="p">)</span>
            <span class="n">plot_line_ids</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">locations</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">locations</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">toReturn</span>
</div>
<div class="viewcode-block" id="HFSModel.plot_spectroscopic"><a class="viewcode-back" href="../../../generated/hfsmodel/satlas.models.hfsmodel.HFSModel.plot_spectroscopic.html#satlas.models.hfsmodel.HFSModel.plot_spectroscopic">[docs]</a>    <span class="k">def</span> <span class="nf">plot_spectroscopic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plots the hfs on top of experimental data</span>
<span class="sd">        with errorbar given by the square root of the data.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x: array</span>
<span class="sd">            Experimental x-data. If None, a suitable region around</span>
<span class="sd">            the peaks is chosen to plot the hfs.</span>
<span class="sd">        y: array</span>
<span class="sd">            Experimental y-data.</span>
<span class="sd">        yerr: array or dict(&#39;high&#39;: array, &#39;low&#39;: array)</span>
<span class="sd">            Experimental errors on y.</span>
<span class="sd">        no_of_points: int</span>
<span class="sd">            Number of points to use for the plot of the hfs if</span>
<span class="sd">            experimental data is given.</span>
<span class="sd">        ax: matplotlib axes object</span>
<span class="sd">            If provided, plots on this axis.</span>
<span class="sd">        show: boolean</span>
<span class="sd">            If True, the plot will be shown at the end.</span>
<span class="sd">        legend: string, optional</span>
<span class="sd">            If given, an entry in the legend will be made for the spectrum.</span>
<span class="sd">        data_legend: string, optional</span>
<span class="sd">            If given, an entry in the legend will be made for the experimental</span>
<span class="sd">            data.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        fig, ax: matplotlib figure and axis</span>
<span class="sd">            Figure and axis used for the plotting.&quot;&quot;&quot;</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">ylow</span><span class="p">,</span> <span class="n">yhigh</span> <span class="o">=</span> <span class="n">poisson_interval</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
            <span class="n">yerr</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;low&#39;</span><span class="p">:</span> <span class="n">y</span> <span class="o">-</span> <span class="n">ylow</span><span class="p">,</span> <span class="s1">&#39;high&#39;</span><span class="p">:</span> <span class="n">yhigh</span> <span class="o">-</span> <span class="n">y</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">yerr</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;yerr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">yerr</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="HFSModel.plot_scheme"><a class="viewcode-back" href="../../../generated/hfsmodel/satlas.models.hfsmodel.HFSModel.plot_scheme.html#satlas.models.hfsmodel.HFSModel.plot_scheme">[docs]</a>    <span class="k">def</span> <span class="nf">plot_scheme</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">upper_color</span><span class="o">=</span><span class="s1">&#39;#D55E00&#39;</span><span class="p">,</span> <span class="n">lower_color</span><span class="o">=</span><span class="s1">&#39;#009E73&#39;</span><span class="p">,</span> <span class="n">arrow_color</span><span class="o">=</span><span class="s1">&#39;#0072B2&#39;</span><span class="p">,</span> <span class="n">distance</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">spectrum</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a figure where both the splitting of the upper and lower state is drawn,</span>
<span class="sd">        and the hfs associated with this.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        show: boolean, optional</span>
<span class="sd">            If True, immediately shows the figure. Defaults to True.</span>
<span class="sd">        upper_color: matplotlib color definition</span>
<span class="sd">            Sets the color of the upper state. Defaults to red.</span>
<span class="sd">        lower_color: matplotlib color definition</span>
<span class="sd">            Sets the color of the lower state. Defaults to black.</span>
<span class="sd">        arrow_color: matplotlib color definition</span>
<span class="sd">            Sets the color of the arrows indicating the transitions.</span>
<span class="sd">            Defaults to blue.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple</span>
<span class="sd">            Tuple containing the figure and both axes, also in a tuple.&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">fractions</span> <span class="kn">import</span> <span class="n">Fraction</span>
        <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">lines</span>
        <span class="n">length_plot</span> <span class="o">=</span> <span class="mf">0.4</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">frameon</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">length_plot</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span> <span class="n">axisbg</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">plot_kws</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="n">distance</span><span class="p">})</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">get_xaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">get_yaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>

        <span class="n">locations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">locations</span>
        <span class="n">plotrange</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()</span>
        <span class="n">distances</span> <span class="o">=</span> <span class="p">(</span><span class="n">locations</span> <span class="o">-</span> <span class="n">plotrange</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">plotrange</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">plotrange</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">length_plot</span>
        <span class="n">height</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">locations</span><span class="p">)</span>
        <span class="n">plotrange</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">spectrum</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">frameon</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">lower_state_height</span> <span class="o">=</span> <span class="mf">0.1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lower_state_height</span> <span class="o">=</span> <span class="mf">0.525</span>
        <span class="n">upper_state_height</span> <span class="o">=</span> <span class="mf">0.95</span>
        <span class="n">height</span> <span class="o">=</span> <span class="p">(</span><span class="n">height</span> <span class="o">-</span> <span class="n">plotrange</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">plotrange</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">plotrange</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_lower</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="s1">&#39;Al&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                              <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_upper</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="s1">&#39;Au&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_lower</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="s1">&#39;Bl&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                              <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_upper</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="s1">&#39;Bu&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_lower</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="s1">&#39;Cl&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                              <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_upper</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="s1">&#39;Cu&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">energies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">C</span> <span class="o">*</span> <span class="n">A</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">D</span> <span class="o">*</span> <span class="n">B</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">E</span> <span class="o">*</span> <span class="n">C</span>

        <span class="n">energy_range</span> <span class="o">=</span> <span class="p">(</span><span class="n">upper_state_height</span> <span class="o">-</span> <span class="n">lower_state_height</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="mf">0.025</span>

        <span class="n">energies_upper</span> <span class="o">=</span> <span class="n">energies</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">num_lower</span><span class="p">:]</span>
        <span class="n">energies_upper_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">energies_upper</span><span class="o">.</span><span class="n">max</span><span class="p">())</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">energies_upper</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">==</span><span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span>
        <span class="n">energies_upper_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ptp</span><span class="p">(</span><span class="n">energies_upper</span><span class="p">)</span>
        <span class="n">energies_upper</span> <span class="o">=</span> <span class="n">energies_upper</span> <span class="o">/</span> <span class="n">energies_upper_norm</span> <span class="o">*</span> <span class="n">energy_range</span>
        <span class="n">energies_lower</span> <span class="o">=</span> <span class="n">energies</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">num_lower</span><span class="p">]</span>
        <span class="n">energies_lower_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">energies_lower</span><span class="o">.</span><span class="n">max</span><span class="p">())</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">energies_lower</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">==</span><span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span>
        <span class="n">energies_lower_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ptp</span><span class="p">(</span><span class="n">energies_lower</span><span class="p">)</span>
        <span class="n">energies_lower</span> <span class="o">=</span> <span class="n">energies_lower</span> <span class="o">/</span> <span class="n">energies_lower_norm</span> <span class="o">*</span> <span class="n">energy_range</span>
        <span class="n">lower_state_height</span> <span class="o">-=</span> <span class="n">energies_lower</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">upper_state_height</span> <span class="o">-=</span> <span class="n">energies_upper</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">energies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">energies_lower</span><span class="p">,</span> <span class="n">energies_upper</span><span class="p">)</span>

        <span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">axisbg</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">get_xaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">get_yaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

        <span class="c1"># Lower state</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">])</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">lower_state_height</span><span class="p">,</span> <span class="n">lower_state_height</span><span class="p">])</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">Line2D</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">2.</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">lower_color</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="c1"># Upper state</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">])</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">upper_state_height</span><span class="p">,</span> <span class="n">upper_state_height</span><span class="p">])</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">Line2D</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">2.</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">upper_color</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">F</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="p">):</span>
            <span class="c1"># Level</span>
            <span class="n">F</span> <span class="o">=</span> <span class="n">Fraction</span><span class="o">.</span><span class="n">from_float</span><span class="p">(</span><span class="n">F</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span> <span class="o">+</span> <span class="n">length_plot</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_lower</span><span class="p">:</span>
                <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="o">+</span> <span class="n">lower_state_height</span> <span class="o">+</span> <span class="n">energies</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">color</span> <span class="o">=</span> <span class="n">lower_color</span>
                <span class="n">starting</span> <span class="o">=</span> <span class="n">lower_state_height</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="o">+</span> <span class="n">upper_state_height</span> <span class="o">+</span> <span class="n">energies</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">color</span> <span class="o">=</span> <span class="n">upper_color</span>
                <span class="n">starting</span> <span class="o">=</span> <span class="n">upper_state_height</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">Line2D</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">2.</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">()])</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">starting</span><span class="p">,</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">Line2D</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">2.</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">)</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">+</span> <span class="n">length_plot</span><span class="p">,</span> <span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;F=&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">F</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;horizontalalignment&#39;</span><span class="p">:</span> <span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="s1">&#39;verticalalignment&#39;</span><span class="p">:</span> <span class="s1">&#39;center&#39;</span><span class="p">})</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ftof</span><span class="p">):</span>
            <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span> <span class="o">=</span> <span class="n">label</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;__&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;_&#39;</span> <span class="ow">in</span> <span class="n">lower</span><span class="p">:</span>
                <span class="n">lower</span> <span class="o">=</span> <span class="n">lower</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
                <span class="n">lower</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">lower</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">lower</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lower</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">lower</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;_&#39;</span> <span class="ow">in</span> <span class="n">upper</span><span class="p">:</span>
                <span class="n">upper</span> <span class="o">=</span> <span class="n">upper</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
                <span class="n">upper</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">upper</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">upper</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">upper</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">upper</span><span class="p">)</span>

            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">distances</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">distances</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span> <span class="o">+</span> <span class="mf">0.5</span>
            <span class="n">lower</span> <span class="o">=</span> <span class="n">energies</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">num_lower</span><span class="p">]</span><span class="o">==</span><span class="n">lower</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">upper</span> <span class="o">=</span> <span class="n">energies</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">num_lower</span><span class="p">:]</span><span class="o">==</span><span class="n">upper</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_lower</span><span class="p">]</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">lower</span> <span class="o">+</span> <span class="n">lower_state_height</span><span class="p">,</span> <span class="n">upper</span> <span class="o">+</span> <span class="n">upper_state_height</span><span class="p">])</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">arrow</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fc</span><span class="o">=</span><span class="n">arrow_color</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="n">arrow_color</span><span class="p">,</span> <span class="n">length_includes_head</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">overhang</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="n">ax2</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">lower_state_height</span> <span class="o">+</span> <span class="mf">0.015</span><span class="p">,</span> <span class="s1">&#39;J=&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">Fraction</span><span class="o">.</span><span class="n">from_float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">J</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;horizontalalignment&#39;</span><span class="p">:</span> <span class="s1">&#39;center&#39;</span><span class="p">})</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">upper_state_height</span> <span class="o">+</span> <span class="mf">0.015</span><span class="p">,</span> <span class="s1">&#39;J=&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">Fraction</span><span class="o">.</span><span class="n">from_float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">J</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;horizontalalignment&#39;</span><span class="p">:</span> <span class="s1">&#39;center&#39;</span><span class="p">})</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">lower_state_height</span><span class="p">,</span> <span class="n">upper_state_height</span><span class="p">])</span> <span class="o">+</span> <span class="mf">0.015</span><span class="p">,</span> <span class="s1">&#39;I=&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">Fraction</span><span class="o">.</span><span class="n">from_float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">I</span><span class="p">)),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;horizontalalignment&#39;</span><span class="p">:</span> <span class="s1">&#39;right&#39;</span><span class="p">})</span>
        <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span></div></div>
</pre></div>

          </div>
        </div>
          </div>
      <div class="spc-rightsidebar span3">
        <div class="sphinxsidebarwrapper">
        </div>
      </div>
        </div>
      </div>
    </div>

    <div class="container container-navbar-bottom">
      <div class="spc-navbar">
        
      </div>
    </div>
    <div class="container">
    <div class="footer">
    <div class="row-fluid">
    <ul class="inline pull-left">
      <li>
        &copy; Copyright 2015, Wouter Gins.
      </li>
      <li>
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.3.1.
      </li>
    </ul>
    </div>
    </div>
    </div>
  </body>
</html>